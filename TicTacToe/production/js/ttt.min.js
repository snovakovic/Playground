var _ttt={ttt:{},logic:{},canvas:{},socket:{},resources:{},view:{}};_ttt.resources={socketUrl:"http://localhost",val:{playerX:"X",playerO:"O",startGame:"start",joinGame:"join",vsPlayer:"vs-player",singleGame:"single",publicGame:"public"},game:{gameId:null,player:null,opponentId:null,boardSize:null,winStreak:null},conf:{lineWidth:4,offset:10,strokeStyle:"#ad2323",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:10,shadowColor:"#656565",animationSpeed:10,boardClearTimeout:5,canvasWidth:null},gameConf:{boardSize:3,winStreak:3,gameMode:"single",gameAction:"start",gameType:"public"},statusCode:{INVALID_MOVE:0,INVALID_PLAYER:1,VALID_MOVE:2,WIN:3,DRAW:4,GAME_END:5},strings:{GAME_WIN:"Player {0} won the game!",GAME_DRAW:"The game is draw.",YOU_LOST:"You lost the game :(",YOU_WIN:"You win the game :)",NEXT_MOVE:"Player {0} is next.",WAIT_FOR_PLAYER:"Wait for your opponent to join!",GAME_ID:"Game Id:",YOUR_TURN:"Your turn, play",OPPONENT_TURN:"Opponent turn, please wait.",WAIT_FOR_REPLY:"Wait for opponent reply",NEW_GAME_REQUEST:"Your opponent request a new game.",REQUEST_REJECTED:"Opponent has rejected your request",OPPONENT_DISCONECTED:"Opponent has disconnected from game!",OPEN_GAMES_HEADER:"Click on game to join",NO_OPEN_GAMES:"There is no public games",NEW_GAME_ERROR:"Game configuration is not correct",SOCKET_CONNECTION_ERROR:'<p class="text-danger"> Problem connecting to socket! </p>'},elId:{gameWrapper:"ttt-game-wrapper",openGamesWrapper:"ttt-open-games-wrapper",exitGameBtn:"ttt-exit-game",statusTxt:"ttt-status-text",newGameBtn:"ttt-new-game"},elClass:{canvasWin:"ttt-win",canvasLose:"ttt-lose",win:"ttt-win alert alert-success",draw:"ttt-draw",lose:"ttt-lose alert alert-danger",nextMove:"ttt-next-move alert alert-info",opponentMove:"ttt-opponent-move alert alert-warning",yourMove:"ttt-your-move alert alert-info",disconnected:"ttt-disconnected-opponent",wiat:"ttt-wait-for-player alert alert-danger",gameId:"ttt-game-id alert alert-info",outOfGame:"ttt-out-of-game",inGame:"ttt-in-game"},callbackFunc:{win:null,lose:null,draw:null}},_ttt.S=function(a){return a.logStatus=!1,a.elem=function(a){return document.querySelector(a)},a.Id=function(a){return document.getElementById(a)},a.S=function(a){var b={},c=[],d=0,e=0;for(c=Array.prototype.slice.call(document.querySelectorAll(a)),d=c.length;d>e;)b[e]=c[e],e++;return b.length=d,b.splice=[].splice(),b.each=function(a){for(var c=0;d>c;)a.call(b[c]),c++},b},a.format=function(){for(var a=arguments[0],b=0;b<arguments.length-1;b++)a=a.replace("{"+b+"}",arguments[b+1]);return a},a.each=function(a,b){var c=0;for(length=a.length;length>c&&b(a[c],c)!==!1;c++);},a.iterate=function(a,b){for(var c=0;a>c&&b(c)!==!1;c++);},a.log=function(){if(a.logStatus)for(var b=0;b<arguments.length;b++)console.log(arguments[b])},a.merge=function(a,b){if(null==a||null==b)return a;for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},a}(_ttt.S||{}),_ttt.view=function(a,b){var c=document.getElementById("ttt-new-game");return{generateGameHtml:function(){var c,d="",e=1,f=1,g=document.getElementById(b.elId.gameWrapper),h=b.game.boardSize,i=g.offsetWidth/h,j=Math.pow(h,2);b.conf.canvasWidth=i,c=a.format('width="{0}" height="{1}" style="width:{2}%"',i,i,100/h),d+=a.format('<canvas {0} data-row="{1}" data-column="{2}" data-diagonal="{3}"></canvas>',c,f-1,e-1,f-1+":"+(e-1));for(var k=1;j>k;k++)f=k%h!==0?f:f+1,e=e%h!==0?e+1:1,d+=a.format('<canvas {0} data-row="{1}" data-column="{2}" data-diagonal="{3}"></canvas>',c,f-1,e-1,f-1+":"+(e-1));d+='<div style="clear:both"></div>',g.innerHTML=d},higlightWin:function(c){a.each(c,function(c){queryAtribute=a.format('[data-diagonal="{0}"]',c),a.elem(queryAtribute).className=b.elClass.canvasWin})},higlightLose:function(c){a.each(c,function(c){queryAtribute=a.format('[data-diagonal="{0}"]',c),a.elem(queryAtribute).className=b.elClass.canvasLose})},waitOpponentHandler:function(){this.displayStatus(b.strings.WAIT_FOR_PLAYER,b.elClass.wiat),this.generateGameHtml(),c&&(c.style.display="none")},startGameHandler:function(a){a&&this.generateGameHtml(),b.game.player===b.val.playerX?this.displayStatus(b.strings.YOUR_TURN,b.elClass.yourMove):this.displayStatus(b.strings.OPPONENT_TURN,b.elClass.opponentMove),c&&(c.style.display="block")},showGame:function(){var c="."+b.elClass.inGame,d="."+b.elClass.outOfGame;a.S(d).each(function(){this.style.display="none"}),a.S(c).each(function(){this.style.display="block"})},hideGame:function(){var c="."+b.elClass.inGame,d="."+b.elClass.outOfGame;a.S(d).each(function(){this.style.display="block"}),a.S(c).each(function(){this.style.display="none"})},clearBoard:function(){var c="#"+b.elId.gameWrapper+" > canvas",d=b.conf.boardClearTimeout,e=0;a.S(c).each(function(){var a=this;e+=d,setTimeout(function(){_ttt.canvas.clearCanvas(a),a.className=""},e)})},displayStatus:function(b,c,d){var e=document.getElementById(_ttt.resources.elId.statusTxt);e&&(d?e.innerHTML+=a.format('<p class="{0}"> {1} </p>',c,b):e.innerHTML=a.format('<p class="{0}"> {1} </p>',c,b))},updateOpenGames:function(c){var d=document.getElementById(b.elId.openGamesWrapper);gameList="",d&&(a.log("Open games:",c),a.each(c,function(b){gameList+=a.format('<p class="ttt-open-game" data-game-id="{0}"> {1} <span class="ttt-game-size">s:{2} w:{3}</span></p>',b.id,b.id,b.boardSize,b.winStreak)}),gameList?(d.innerHTML=a.format('<p class="ttt-open-games-header">{0}</p>',b.strings.OPEN_GAMES_HEADER),d.innerHTML+=gameList):d.innerHTML=a.format('<p class="ttt-no-games">{0}</p>',b.strings.NO_OPEN_GAMES))},newGame:function(){this.generateGameHtml(),b.gameConf.gameMode===b.val.singleGame?(b.game.player=b.val.playerX,view.displayStatus(a.format(b.strings.NEXT_MOVE,b.game.player),b.elClass.nextMove)):(ttt.switchPlayer(),player===b.val.playerX?view.displayStatus(b.strings.YOUR_MOVE,b.elClass.yourMove):view.displayStatus(b.strings.OPPONENT_TURN,b.elClass.opponentMove))},disableSocket:function(){var c=document.getElementById("ttt-game-id"),d=document.getElementById("ttt-open-games-wrapper");c&&c.setAttribute("disabled","disabled"),d&&(d.innerHTML=b.strings.SOCKET_CONNECTION_ERROR),a.S('input[name="gameMode"]').each(function(){this.value===b.val.vsPlayer&&this.setAttribute("disabled","disabled")})},startEventListeners:function(){$restartGameBtn=document.getElementById(b.elId.newGameBtn),$restartGameBtn&&$restartGameBtn.addEventListener("click",function(){a.log("Restart game btn listener"),b.gameConf.gameMode===b.val.singleGame?ttt.restartGame():ttt.requestNewGame()},!1),$exitGameBtn=document.getElementById(b.elId.exitGameBtn),$exitGameBtn&&$exitGameBtn.addEventListener("click",function(){a.log("Exit game btn listener"),ttt.exitGame()},!1),document.getElementById(b.elId.gameWrapper).addEventListener("click",function(b){a.log("click on:",b.target),b.target&&"CANVAS"==b.target.nodeName&&(a.log("Game field click listener"),ttt.move(b.target))}),$openGamesWrapper=document.getElementById(b.elId.openGamesWrapper),$openGamesWrapper&&$openGamesWrapper.addEventListener("click",function(a){if(a.target&&"P"==a.target.nodeName&&"ttt-open-game"===a.target.className){var c=a.target.getAttribute("data-game-id");ttt.newGame({gameMode:b.val.vsPlayer,gameAction:b.val.joinGame,gameId:c})}}),_ttt.view.startEventListeners=function(){}}}}(_ttt.S,_ttt.resources),_ttt.logic=function(a,b){function c(a,b){var c,e,g,i=a.row,k=a.column;return c=h.filter(function(a){return a.player==b}),c.length<f?!1:(e=c.filter(function(a){return a.row==i}),e.length>=f&&(g=d(e,!0))?(j.player=b,j.line=g,!0):(e=c.filter(function(a){return a.column==k}),e.length>=f&&(g=d(e,!1))?(j.player=b,j.line=g,!0):(e=c.filter(function(a){return i-a.row===k-a.column}),e.length>=f&&(g=d(e,!1))?(j.player=b,j.line=g,!0):(e=c.filter(function(a){return i-a.row===-1*(k-a.column)}),e.length>=f&&(g=d(e,!1))?(j.player=b,j.line=g,!0):!1))))}function d(a,b){var c=[],d=1;b===!0?a.sort(function(a,b){return a.column-b.column}):a.sort(function(a,b){return a.row-b.row});for(var e=0,g=a.length;g>e;e++)if(0===e)c.push(a[e].row+":"+a[e].column);else if(b||a[e-1].row+1!==a[e].row)if(b&&a[e-1].column+1===a[e].column)c.push(a[e].row+":"+a[e].column),d++;else{if(d>=f)return c;d=1,g-=e,c=[]}else c.push(a[e].row+":"+a[e].column),d++;return d>=f?c:!1}function e(){g=g===b.val.playerX?b.val.playerO:b.val.playerX}var f,g=b.val.playerX,h=[],i=!1,j={},k={playerX:0,playerO:0,draw:0};return{move:function(d,f,j){var l,m={row:parseInt(f,10),column:parseInt(j,10),player:g};return d!==g?(a.log("Invalid Player!"),b.statusCode.INVALID_PLAYER):i?(a.log("Game has ended!"),b.statusCode.GAME_END):(a.log("your move row: "+f+" column: "+j),(l=h.some(function(a){return a.row===m.row&&a.column===m.column}))?(a.log("Invalid move!"),b.statusCode.INVALID_MOVE):(h.push(m),a.log(h),c(m,g)?(a.log("Win!"),i=!0,g===b.val.playerX?k.playerX++:k.playerO++,b.statusCode.WIN):h.length===Math.pow(b.game.boardSize,2)?(a.log("Draw!"),i=!0,k.draw++,b.statusCode.DRAW):(e(),b.statusCode.VALID_MOVE)))},newGame:function(){b.game.winStreak=parseInt(b.game.winStreak,10),b.game.boardSize=parseInt(b.game.boardSize,10),f=b.game.winStreak<=b.game.boardSize?b.game.winStreak:b.game.boardSize,h=[],j={},i=!1,g=b.val.playerX},getWinStatus:function(){return j},getNextPlayer:function(){return g},getScores:function(){return k},getPlayedMoves:function(){return h.length>0?h:!1}}}(_ttt.S,_ttt.resources),_ttt.socket=function(a,b){function c(){var a=b.gameConf.gameType===b.val.publicGame?!0:!1;b.game={id:f,isOpen:!0,isPublic:a,boardSize:b.gameConf.boardSize,winStreak:b.gameConf.winStreak},e.emit("start-game",b.game),ttt.waitForOpponent(f)}function d(){e.on("connect",function(){f=this.socket.sessionid,a.log("Connected to socket, socket id: "+f),e.emit("open-games-request")}),e.on("disconnect",function(){this.socket.connect()}),e.on("reconnect",function(){f=this.socket.sessionid,c(),a.log("socket reconnected"),e.emit("open-games-request")}),e.on("start-game",function(a){ttt.startGameResponseReceived(a)}),e.on("opponent-move",function(b){a.log("Opponent move:"+b),ttt.move(null,b)}),e.on("new-game-request",function(){confirm(b.strings.NEW_GAME_REQUEST)?(e.emit("new-game-response",!0,b.game.opponentId),ttt.restartGame()):e.emit("new-game-response",!1,b.game.opponentId)}),e.on("new-game-response",function(a){a?ttt.restartGame():alert(b.strings.REQUEST_REJECTED)}),e.on("open-games-list",function(a){ttt.updateOpenGames(a)}),e.on("socket-disconnect",function(c){a.log("socket disconnect with id:"+c),c===b.game.opponentId&&ttt.onOpponentDisconnect()}),d=function(){}}var e,f;return{init:function(){if(e)return!1;try{e=io.connect(b.socketUrl),d()}catch(c){a.log(c),_ttt.view.disableSocket()}},disconnect:function(){e&&(e.disconnect(),f=null,a.log("socket is disconnected"))},startMultiplayerGame:function(){e&&!f?e.socket.reconnect():c()},joinMultiplayerGame:function(a){e&&e.emit("join-game",a)},requestNewGame:function(){e&&b.game.opponentId&&(a.log("new-game request opponent: "+b.game.opponentId),e.emit("new-game-request",b.game.opponentId),view.displayStatus(b.strings.WAIT_FOR_REPLY,b.game.player,"ttt-wait"))},requestOpeneGames:function(){e.emit("open-games-request")},move:function(a){e.emit("move",a)}}}(_ttt.S,_ttt.resources),_ttt.canvas=function(a,b){function c(){var b,c,d,e=g.offsetWidth;e!==h&&(h=e,ttt.generateGameHtml(),b=ttt.getPlayedMoves(),b&&(a.each(b,function(b){c=b.row+":"+b.column,d=a.elem('[data-diagonal="'+c+'"]'),_ttt.canvas.instantDraw(d,b.player)}),a.log(b)))}function d(a,c,d){var e=0,f=setInterval(function(){e+=.05,e>1&&(e=1,clearInterval(f),d&&"function"==typeof d&&d(!0)),a.clearRect(0,0,c.width,c.height),a.moveTo(c.startX,c.startY),a.lineTo(c.startX+(c.endX-c.startX)*e,c.startY+(c.endY-c.startY)*e),a.stroke()},b.conf.animationSpeed)}function e(a){return a.lineWidth=b.conf.lineWidth,a.strokeStyle=b.conf.strokeStyle,a.shadowOffsetX=b.conf.shadowOffsetX,a.shadowOffsetY=b.conf.shadowOffsetY,a.shadowBlur=b.conf.shadowBlur,a.shadowColor=b.conf.shadowColor,a}var f,g=document.getElementById("ttt-game-wrapper"),h=g.offsetWidth;return window.onresize=function(){clearTimeout(f),f=setTimeout(c,300)},{draw:function(a,c){c===b.val.playerX?this.drawX(a):this.drawO(a)},instantDraw:function(a,c){c===b.val.playerX?this.drawX(a,!0):this.drawO(a,!0)},drawX:function(a,c){var f,g=b.conf.offset,h=b.conf.canvasWidth,i=b.conf.canvasWidth;f=a.getContext("2d"),f=e(f),f.beginPath();var j={startX:g,startY:g,endX:h-g,endY:i-g,width:h,height:i},k={startX:h-g,startY:g,endX:g,endY:i-g,width:h,height:i};c===!0?(f.moveTo(j.startX,j.startY),f.lineTo(j.endX,j.endY),f.moveTo(k.startX,k.startY),f.lineTo(k.endX,k.endY),f.stroke()):d(f,j,function(){d(f,k)})},drawO:function(a,c){var d,f,g=b.conf.canvasWidth,h=b.conf.canvasWidth,i=g/2,j=h/2,k=h/2-b.conf.offset,l=100,m=0,n=0,o=2*Math.PI,p=Math.PI/2;d=a.getContext("2d"),d=e(d),c?(d.clearRect(0,0,g,h),d.beginPath(),d.arc(i,j,k,0,o),d.stroke()):f=setInterval(function(){m>l&&(m=1,clearInterval(f)),d.clearRect(0,0,g,h),d.beginPath(),d.arc(i,j,k,-p,o*n-p,!1),d.stroke(),m+=3,n=m/100},b.conf.animationSpeed)},clearCanvas:function(a){var c=a.getContext("2d"),d=b.conf.canvasWidth,e=b.conf.canvasWidth;c.clearRect(0,0,d,e)}}}(_ttt.S,_ttt.resources);var ttt=_ttt.ttt=function(a,b,c,d,e){function f(c){var f;f=e.getWinStatus(),a.log(f),b.gameConf.gameMode===b.val.singleGame?(d.displayStatus(a.format(b.strings.GAME_WIN,f.player),b.elClass.win),"function"==typeof b.callbackFunc.win&&b.callbackFunc.win(f.player)):c?(d.displayStatus(b.strings.YOU_WIN,b.elClass.win),"function"==typeof b.callbackFunc.win&&b.callbackFunc.win(f.player)):(d.displayStatus(b.strings.YOU_LOST,b.elClass.lose),"function"==typeof b.callbackFunc.lose&&b.callbackFunc.lose(f.player)),f.line&&(a.log(f.line),c?d.higlightWin(f.line):d.higlightLose(f.line))}function g(){d.displayStatus(b.strings.GAME_DRAW,b.elClass.draw),"function"==typeof b.callbackFunc.draw&&b.callbackFunc.draw()}function h(){b.game={player:b.val.playerX,boardSize:b.gameConf.boardSize,winStreak:b.gameConf.winStreak},d.displayStatus(a.format(b.strings.NEXT_MOVE,b.game.player),b.elClass.nextMove),i=!1,d.generateGameHtml()}var i=!1;return{init:function(e){b.conf=a.merge(b.conf,e),a.log("Configuration:",b.conf),c.init(),d.startEventListeners()},newGame:function(f){if(b.gameConf=a.merge(b.gameConf,f),a.log("Game configuration:",b.gameConf),d.showGame(),b.gameConf.gameMode===b.val.singleGame)h();else if(b.gameConf.gameMode===b.val.vsPlayer&&b.gameConf.gameAction===b.val.startGame)c.startMultiplayerGame(),i=!0;else{if(b.gameConf.gameMode!==b.val.vsPlayer||b.gameConf.gameAction!==b.val.joinGame)return alert(b.strings.NEW_GAME_ERROR),!1;c.joinMultiplayerGame(b.gameConf.gameId),i=!0}return e.newGame(),!0},startGameResponseReceived:function(c){var f=b.gameId?!1:!0;c.success?(a.log("Server response:",c),b.game=c,d.startGameHandler(f),e.newGame()):(alert(c.message),d.hideGame())},move:function(h,j){var k,l,m,n,o=!1;h?(k=h.getAttribute("data-row"),l=h.getAttribute("data-column"),m=b.game.player,o={opponentId:b.game.opponentId,row:k,column:l,player:m}):j&&(k=j.row,l=j.column,m=j.player,h=a.elem(a.format('[data-diagonal="{0}:{1}"]',k,l))),n=e.move(m,k,l),n===b.statusCode.VALID_MOVE?(_ttt.canvas.draw(h,m),b.gameConf.gameMode===b.val.singleGame?(d.displayStatus(a.format(b.strings.NEXT_MOVE,e.getNextPlayer()),b.elClass.nextMove),this.switchPlayer()):o?(c.move(o),d.displayStatus(a.format(b.strings.OPPONENT_TURN),b.elClass.opponentMove)):d.displayStatus(a.format(b.strings.YOUR_TURN),b.elClass.yourMove)):n===b.statusCode.WIN?(_ttt.canvas.draw(h,m),f(o),o&&i&&c.move(o)):n===b.statusCode.DRAW&&(_ttt.canvas.draw(h,m),g(),o&&i&&c.move(o))},restartGame:function(){e.newGame(),d.newGame()},exitGame:function(){b.gameConf.gameMode===b.val.vsPlayer&&c.disconnect(),d.hideGame(),b.game={}},onOpponentDisconnect:function(){alert(b.strings.OPPONENT_DISCONECTED),d.displayStatus(b.strings.OPPONENT_DISCONECTED,b.elClass.disconected),ttt.stopGame()},updateOpenGames:function(a){d.updateOpenGames(a)},waitForOpponent:function(a){d.waitOpponentHandler(),d.displayStatus(b.strings.GAME_ID+" "+a,b.elClass.gameId,!0)},getScores:function(){return e.getScores()},getPlayedMoves:function(){return e.getPlayedMoves()},enableLogMsg:function(b){a.logStatus=b===!0?!0:!1},registerCallbacks:function(a){b.callbackFunc=a||{}},stopGame:function(){b.game={}},generateGameHtml:function(){d.generateGameHtml()},requestNewGame:function(){c.requestNewGame()},switchPlayer:function(){b.game.player=b.game.player===b.val.playerX?b.val.playerO:b.val.playerX}}}(_ttt.S,_ttt.resources,_ttt.socket,_ttt.view,_ttt.logic);